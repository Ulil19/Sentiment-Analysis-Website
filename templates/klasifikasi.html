{% extends 'layouts/base.html' %}
{% block title %}Klasifikasi{% endblock %}
{% block content %}

<!-- Form Pilih File -->
<div class="mx-auto mt-8 mb-8 p-6 bg-white rounded-xl shadow space-y-6">
    <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
        <i class="fas fa-robot"></i> Klasifikasi Sentimen (Random Forest)
    </h2>
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="space-y-1 text-sm">
        {% for category, message in messages %}
        <div class="px-3 py-1 rounded text-white font-medium text-sm
                        {% if category == 'success' %}
                            bg-green-500
                        {% elif category == 'error' %}
                            bg-red-500
                        {% elif category == 'warning' %}
                            bg-yellow-500 text-gray-800
                        {% else %}
                            bg-blue-500
                        {% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <form action="{{ url_for('preview_klasifikasi') }}" method="post" class="space-y-6">
        <div>
            <label for="file" class="block text-sm font-medium text-gray-700 mb-2">Pilih File</label>
            <select name="file" id="file" required
                class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option disabled selected>Pilih file untuk diproses</option>
                {% for file in projects %}
                <option value="{{ file.nama_aplikasi }}" {% if selected_app==file.nama_aplikasi %}selected{% endif %}>
                    {{ file.nama_aplikasi }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" name="preview"
            class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 flex items-center gap-2">
            <i class="fas fa-eye"></i> Lihat Data
        </button>
    </form>
</div>

<!-- Tabel Preview Data -->
{% if preview_data %}

<div class="mx-auto mb-12 p-6 bg-white rounded-xl shadow-lg">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fas fa-table text-indigo-500"></i> Tabel Preview Data
        </h3>
        <form id="klasifikasi-form" action="{{ url_for('run_klasifikasi') }}" method="post">
            <input type="hidden" name="nama_aplikasi" value="{{ selected_app }}">
            <button type="submit"
                class="px-5 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                Klasifikasi
            </button>
        </form>
        <div id="status-box"
            class="bg-gray-800 text-white p-2 rounded shadow hidden text-sm min-w-[180px] text-center mb-4">
        </div>
    </div>
    <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full bg-white rounded-lg shadow border border-gray-200">
            <thead>
                <tr class="bg-gradient-to-r from-indigo-400 via-indigo-600 to-blue-500 text-white">
                    {% for col in preview_data[0].keys() %}
                    <th
                        class="px-6 py-4 text-left text-sm font-extrabold uppercase tracking-wider first:rounded-tl-lg last:rounded-tr-lg">
                        {{ col }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in preview_data %}
                <tr class="hover:bg-blue-50 transition">
                    {% for val in row.values() %}
                    <td class="px-6 py-3 text-sm text-gray-800 border-b border-gray-100">{{ val }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
    document.getElementById("klasifikasi-form")?.addEventListener("submit", function (e) {
        e.preventDefault(); // selalu cegah submit default dulu

        Swal.fire({
            title: 'Anda yakin?',
            text: "Data akan di klasifikasi dan diproses ulang!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, lakukan!'
        }).then((result) => {
            if (result.isConfirmed) {
                // disable sidebar & buttons hanya kalau konfirmasi
                const sidebarWrapper = document.getElementById("sidebarWrapper");
                sidebarWrapper.classList.add("bg-gray-500", "bg-opacity-50", "pointer-events-none");

                const buttons = document.querySelectorAll("button");
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add("opacity-50", "cursor-not-allowed");
                });

                const statusBox = document.getElementById("status-box");
                if (statusBox) {
                    statusBox.innerHTML = `<span class="flex items-center justify-center gap-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                        Memproses data...
                    </span>`;
                    statusBox.classList.remove("hidden");
                }

                this.submit();
            }
        });
    });
    // Inisialisasi DataTable
    document.addEventListener("DOMContentLoaded", function () {
        if (document.getElementById('dataTable')) {
            $('#dataTable').DataTable({
                pageLength: 5,
                lengthMenu: [5, 10, 25, 50],
                language: {
                    search: "Cari:",
                    lengthMenu: "Tampilkan _MENU_ data",
                    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
                    paginate: {
                        first: "Awal",
                        last: "Akhir",
                        next: "Berikutnya",
                        previous: "Sebelumnya"
                    },
                    zeroRecords: "Data tidak ditemukan"
                }
            });
        }
    });
</script>
{% endblock %}